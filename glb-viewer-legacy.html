<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLB Viewer –∑ Bloom Effect (Legacy –≤–µ—Ä—Å—ñ—è)</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 100%);
      color: white;
    }
    #app {
      width: 100vw;
      height: 100vh;
    }
    
    .controls {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .control-group {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .control-group:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: #aaa;
    }
    
    .control-group input[type="range"] {
      width: 100%;
      margin-bottom: 5px;
    }
    
    .control-group input[type="radio"] {
      margin-right: 5px;
    }
    
    .control-group .radio-label {
      display: inline;
      margin-right: 15px;
      font-size: 11px;
    }
    
    button {
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-size: 12px;
      margin-top: 10px;
      width: 100%;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .value {
      font-size: 10px;
      color: #888;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <div class="controls">
    <div class="control-group">
      <label>Bloom Mode</label>
  <label class="radio-label"><input type="radio" name="bloom-mode" value="simple" checked> Simple</label>
  <label class="radio-label"><input type="radio" name="bloom-mode" value="selective"> Selective</label>
    </div>
    
    <div class="control-group">
      <label>Strength: <span id="strength-value" class="value">1.5</span></label>
      <input type="range" id="strength" min="0" max="3" step="0.1" value="1.5">
    </div>
    
    <div class="control-group">
      <label>Threshold: <span id="threshold-value" class="value">0.1</span></label>
      <input type="range" id="threshold" min="0" max="1" step="0.01" value="0.1">
    </div>
    
    <div class="control-group">
      <label>Radius: <span id="radius-value" class="value">0.4</span></label>
      <input type="range" id="radius" min="0" max="1" step="0.01" value="0.4">
    </div>
    
    <div class="control-group">
      <label>Exposure: <span id="exposure-value" class="value">1</span></label>
      <input type="range" id="exposure" min="0.1" max="2" step="0.1" value="1">
    </div>
    
    <div class="control-group">
      <label>Glow Intensity: <span id="glow-intensity-value" class="value">2</span></label>
      <input type="range" id="glow-intensity" min="0" max="5" step="0.1" value="2">
    </div>
    
    <div class="control-group">
      <label>Glow Hue: <span id="glow-hue-value" class="value">0.6</span></label>
      <input type="range" id="glow-hue" min="0" max="1" step="0.01" value="0.6">
    </div>
    
  <button id="pulse-button" class="pulse-btn">üí´ Enable Pulse</button>
  </div>

<!-- Three.js —Ç–∞ –¥–æ–¥–∞—Ç–∫–∏ —á–µ—Ä–µ–∑ CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script>
  // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
  let scene, camera, renderer, composer, simpleComposer, selectiveComposer;
  let model, glowMeshes = [];
  let currentBloomMode = 'simple';
  let pulseEnabled = false;
  let pulseSpeed = 2.0;
  let pulseIntensity = 1.0;

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ bloom
  const bloomParams = {
    exposure: 1,
    bloomStrength: 1.5,
    bloomThreshold: 0.1,
    bloomRadius: 0.4
  };

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ glow
  const glowParams = {
    intensity: 2.0,
    hue: 0.6
  };

  // –®–µ–π–¥–µ—Ä–∏ –¥–ª—è —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ–≥–æ bloom
  const vertexShader = `
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `;

  const fragmentShader = `
    uniform sampler2D baseTexture;
    uniform sampler2D bloomTexture;
    varying vec2 vUv;
    
    void main() {
      gl_FragColor = (texture2D(baseTexture, vUv) + vec4(1.0) * texture2D(bloomTexture, vUv));
    }
  `;

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
  function init() {
    const container = document.getElementById('app');

    // –°—Ü–µ–Ω–∞
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a0a);

    // –ö–∞–º–µ—Ä–∞
    camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(2.5, 1.8, 3.5);

    // –†–µ–Ω–¥–µ—Ä–µ—Ä
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.toneMapping = THREE.ReinhardToneMapping;
    renderer.toneMappingExposure = bloomParams.exposure;
    container.appendChild(renderer.domElement);

    // –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    // –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è
    const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 5, 5);
    scene.add(directionalLight);

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä—ñ–≤
    initSimpleBloom();
    initSelectiveBloom();

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ
    loadModel();

    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è UI
    setupUI();

    // –ó–∞–ø—É—Å–∫ –∞–Ω—ñ–º–∞—Ü—ñ—ó
    animate();

    // –û–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞
    window.addEventListener('resize', onWindowResize);
  }

  // –ü—Ä–æ—Å—Ç–∏–π bloom –∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä
  function initSimpleBloom() {
    const renderPass = new THREE.RenderPass(scene, camera);
    const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
    bloomPass.threshold = bloomParams.bloomThreshold;
    bloomPass.strength = bloomParams.bloomStrength;
    bloomPass.radius = bloomParams.bloomRadius;

    simpleComposer = new THREE.EffectComposer(renderer);
    simpleComposer.addPass(renderPass);
    simpleComposer.addPass(bloomPass);
  }

  // –°–µ–ª–µ–∫—Ç–∏–≤–Ω–∏–π bloom –∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä
  function initSelectiveBloom() {
    const renderPass = new THREE.RenderPass(scene, camera);
    const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);

    selectiveComposer = new THREE.EffectComposer(renderer);
    selectiveComposer.addPass(renderPass);
    selectiveComposer.addPass(bloomPass);

    // –ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä –¥–ª—è –∑–º—ñ—à—É–≤–∞–Ω–Ω—è
    composer = new THREE.EffectComposer(renderer);
    composer.addPass(renderPass);

    const finalPass = new THREE.ShaderPass(
      new THREE.ShaderMaterial({
        uniforms: {
          baseTexture: { value: null },
          bloomTexture: { value: selectiveComposer.renderTarget2.texture }
        },
        vertexShader: vertexShader,
        fragmentShader: fragmentShader,
        defines: {}
      }), 'baseTexture'
    );
    finalPass.needsSwap = true;
    composer.addPass(finalPass);
  }

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ
  function loadModel() {
    const loader = new THREE.GLTFLoader();
    
    // –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Susanna1.glb
    loader.load(
      './Susanna1.glb',
      function(gltf) {
        model = gltf.scene;
        scene.add(model);
        addInnerGlow();
        console.log('–ú–æ–¥–µ–ª—å Susanna1.glb —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
      },
      function(progress) {
        console.log('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', (progress.loaded / progress.total * 100) + '%');
      },
      function(error) {
        console.log('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Susanna1.glb, –ø—Ä–æ–±—É—é Susanna.glb...', error);
        
        // –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è, –ø—Ä–æ–±—É—î–º–æ Susanna.glb
        loader.load(
          './Susanna.glb',
          function(gltf) {
            model = gltf.scene;
            scene.add(model);
            addInnerGlow();
            console.log('–ú–æ–¥–µ–ª—å Susanna.glb —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
          },
          function(progress) {
            console.log('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', (progress.loaded / progress.total * 100) + '%');
          },
          function(error) {
            console.error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∂–æ–¥–Ω—É –º–æ–¥–µ–ª—å:', error);
          }
        );
      }
    );
  }

  // –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ —Å–≤—ñ—á–µ–Ω–Ω—è
  function addInnerGlow() {
    if (!model) return;

    glowMeshes = [];
    const meshesToProcess = [];
    
    model.traverse(function(child) {
      if (child.isMesh) {
        meshesToProcess.push(child);
      }
    });

    meshesToProcess.forEach(mesh => {
      const glowMaterial = new THREE.MeshBasicMaterial({
        color: new THREE.Color().setHSL(glowParams.hue, 1, 0.5),
        transparent: true,
        opacity: 0.6,
        side: THREE.BackSide
      });

      const glowMesh = new THREE.Mesh(mesh.geometry, glowMaterial);
      glowMesh.scale.multiplyScalar(1.02);
      glowMesh.layers.enable(1);
      
      model.add(glowMesh);
      glowMeshes.push(glowMesh);
    });

    console.log('–î–æ–¥–∞–Ω–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—î —Å–≤—ñ—á–µ–Ω–Ω—è –¥–æ', glowMeshes.length, '–º–µ—à—ñ–≤');
  }

  // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—É–ª—å—Å–∞—Ü—ñ—ó
  function updatePulse() {
    if (!pulseEnabled || glowMeshes.length === 0) return;

    const time = Date.now() * 0.001;
    const pulse = Math.sin(time * pulseSpeed) * 0.5 + 0.5;
    const intensity = glowParams.intensity * (0.5 + pulse * pulseIntensity);

    glowMeshes.forEach(mesh => {
      const hsl = {};
      mesh.material.color.getHSL(hsl);
      mesh.material.color.setHSL(glowParams.hue, 1, 0.3 + intensity * 0.2);
      mesh.material.opacity = 0.4 + intensity * 0.2;
    });
  }

  // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è UI
  function setupUI() {
    // Bloom —Ä–µ–∂–∏–º
    const bloomModeRadios = document.querySelectorAll('input[name="bloom-mode"]');
    bloomModeRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        currentBloomMode = this.value;
      });
    });

    // –°–ª–∞–π–¥–µ—Ä–∏
    const strengthSlider = document.getElementById('strength');
    const thresholdSlider = document.getElementById('threshold');
    const radiusSlider = document.getElementById('radius');
    const exposureSlider = document.getElementById('exposure');
    const glowIntensitySlider = document.getElementById('glow-intensity');
    const glowHueSlider = document.getElementById('glow-hue');

    // –ó–Ω–∞—á–µ–Ω–Ω—è —Å–ª–∞–π–¥–µ—Ä—ñ–≤
    const strengthValue = document.getElementById('strength-value');
    const thresholdValue = document.getElementById('threshold-value');
    const radiusValue = document.getElementById('radius-value');
    const exposureValue = document.getElementById('exposure-value');
    const glowIntensityValue = document.getElementById('glow-intensity-value');
    const glowHueValue = document.getElementById('glow-hue-value');

    // –û–±—Ä–æ–±–Ω–∏–∫–∏ —Å–ª–∞–π–¥–µ—Ä—ñ–≤
    strengthSlider.addEventListener('input', function() {
      bloomParams.bloomStrength = parseFloat(this.value);
      strengthValue.textContent = this.value;
      updateBloomParams();
    });

    thresholdSlider.addEventListener('input', function() {
      bloomParams.bloomThreshold = parseFloat(this.value);
      thresholdValue.textContent = this.value;
      updateBloomParams();
    });

    radiusSlider.addEventListener('input', function() {
      bloomParams.bloomRadius = parseFloat(this.value);
      radiusValue.textContent = this.value;
      updateBloomParams();
    });

    exposureSlider.addEventListener('input', function() {
      bloomParams.exposure = parseFloat(this.value);
      exposureValue.textContent = this.value;
      renderer.toneMappingExposure = bloomParams.exposure;
    });

    glowIntensitySlider.addEventListener('input', function() {
      glowParams.intensity = parseFloat(this.value);
      glowIntensityValue.textContent = this.value;
      updateGlowParams();
    });

    glowHueSlider.addEventListener('input', function() {
      glowParams.hue = parseFloat(this.value);
      glowHueValue.textContent = this.value;
      updateGlowParams();
    });

    // –ö–Ω–æ–ø–∫–∞ –ø—É–ª—å—Å–∞—Ü—ñ—ó
    const pulseButton = document.getElementById('pulse-button');
    pulseButton.addEventListener('click', function() {
      pulseEnabled = !pulseEnabled;
  this.textContent = pulseEnabled ? 'üî¥ Disable Pulse' : 'üí´ Enable Pulse';
    });
  }

  // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ bloom
  function updateBloomParams() {
    if (simpleComposer && simpleComposer.passes[1]) {
      const bloomPass = simpleComposer.passes[1];
      bloomPass.strength = bloomParams.bloomStrength;
      bloomPass.threshold = bloomParams.bloomThreshold;
      bloomPass.radius = bloomParams.bloomRadius;
    }
    
    if (selectiveComposer && selectiveComposer.passes[1]) {
      const bloomPass = selectiveComposer.passes[1];
      bloomPass.strength = bloomParams.bloomStrength;
      bloomPass.threshold = bloomParams.bloomThreshold;
      bloomPass.radius = bloomParams.bloomRadius;
    }
  }

  // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ glow
  function updateGlowParams() {
    glowMeshes.forEach(mesh => {
      mesh.material.color.setHSL(glowParams.hue, 1, 0.5);
    });
  }

  // –û–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞
  function onWindowResize() {
    const container = document.getElementById('app');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
    
    if (simpleComposer) simpleComposer.setSize(container.clientWidth, container.clientHeight);
    if (selectiveComposer) selectiveComposer.setSize(container.clientWidth, container.clientHeight);
    if (composer) composer.setSize(container.clientWidth, container.clientHeight);
  }

  // –ê–Ω—ñ–º–∞—Ü—ñ–π–Ω–∏–π —Ü–∏–∫–ª
  function animate() {
    requestAnimationFrame(animate);
    
    updatePulse();
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä–µ–∂–∏–º—É bloom
    if (currentBloomMode === 'simple') {
      simpleComposer.render();
    } else {
      // –°–µ–ª–µ–∫—Ç–∏–≤–Ω–∏–π bloom
      camera.layers.set(1);
      selectiveComposer.render();
      camera.layers.set(0);
      composer.render();
    }
  }

  // –ó–∞–ø—É—Å–∫ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
  window.addEventListener('load', init);
</script>

</body>
</html>